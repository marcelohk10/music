<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Links de Música (Contador Global)</title>

    <script src="https://cdn.jsdelivr.net/npm/counterapi/dist/counter.browser.min.js"></script>

    <style>
        /* O CSS (estilo) é o mesmo */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #121212;
            color: #ffffff;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }
        .container {
            width: 100%;
            max-width: 500px;
            text-align: center;
        }
        .search-box {
            background-color: #1e1e1e;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            margin-bottom: 20px;
        }
        input[type="text"] {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #333;
            border-radius: 5px;
            background-color: #282828;
            color: #ffffff;
            font-size: 1em;
            margin-bottom: 15px;
            box-sizing: border-box;
        }
        #search-button {
            padding: 12px 20px;
            width: 100%;
            border: none;
            border-radius: 5px;
            background-color: #1DB954;
            color: #ffffff;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #search-button:hover {
            background-color: #1ED760;
        }
        #loading {
            display: none;
            color: #b3b3b3;
            margin: 20px 0;
        }
        #results-container {
            display: none;
            background-color: #1e1e1e;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            overflow: hidden;
        }
        #song-info {
            padding: 25px;
            border-bottom: 1px solid #282828;
        }
        #song-info img {
            width: 120px;
            height: 120px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        #song-title {
            font-size: 1.5em;
            font-weight: bold;
            margin: 0;
        }
        #song-artist {
            font-size: 1.1em;
            color: #b3b3b3;
            margin: 5px 0 0 0;
        }
        #links-container {
            display: flex;
            flex-direction: column;
            gap: 1px;
            background-color: #282828;
        }
        .music-platform-button {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 18px;
            background-color: #1e1e1e;
            color: #ffffff;
            text-decoration: none;
            font-size: 1.1em;
            font-weight: bold;
            text-align: left;
            transition: background-color 0.2s;
        }
        .music-platform-button:hover {
            background-color: #333;
        }
        .platform-name::before {
            content: '▶';
            margin-right: 12px;
            font-size: 0.8em;
        }
        .spotify .platform-name::before { color: #1DB954; }
        .appleMusic .platform-name::before { color: #FA58D8; }
        .deezer .platform-name::before { color: #FEAA2D; }
        .youtubeMusic .platform-name::before { color: #FF0000; }
        .tidal .platform-name::before { color: #00ffff; }
        .click-counter {
            font-size: 0.9em;
            color: #b3b3b3;
            font-weight: normal;
            background-color: #282828;
            padding: 3px 8px;
            border-radius: 5px;
        }
        #graph-container {
            padding: 25px;
            border-top: 1px solid #282828;
        }
        #graph-container h3 {
            margin-top: 0;
            text-align: left;
            color: #b3b3b3;
            font-size: 1em;
            text-transform: uppercase;
        }
        .graph-bar-container {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        .graph-label {
            color: #fff;
            font-size: 0.9em;
            width: 100px;
            text-align: left;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .graph-bar-bg {
            flex-grow: 1;
            background-color: #333;
            border-radius: 3px;
            height: 20px;
            overflow: hidden;
        }
        .graph-bar {
            height: 100%;
            background-color: #1DB954;
            width: 0%;
            transition: width 0.5s ease-out;
            color: #121212;
            font-size: 0.8em;
            font-weight: bold;
            line-height: 20px;
            text-align: right;
            padding-right: 5px;
            box-sizing: border-box;
        }
        .graph-bar.spotify { background-color: #1DB954; }
        .graph-bar.appleMusic { background-color: #FA58D8; }
        .graph-bar.deezer { background-color: #FEAA2D; }
        .graph-bar.youtubeMusic { background-color: #FF0000; }
        .graph-bar.tidal { background-color: #00ffff; color: #121212;}
    </style>
</head>
<body>

    <div class="container">
        <div class="search-box">
            <h1 style="margin-top: 0;">Links de Música</h1>
            <input type="text" id="artist-input" placeholder="Nome do Artista">
            <input type="text" id="song-input" placeholder="Nome da Música">
            <button id="search-button">Buscar Links</button>
            <div id="loading">Buscando...</div>
        </div>

        <div id="results-container">
            <div id="song-info">
                <img id="artwork" src="" alt="Capa do Álbum">
                <h2 id="song-title"></h2>
                <p id="song-artist"></p>
            </div>
            <div id="links-container">
                </div>
            <div id="graph-container">
                <h3>Estatísticas de Cliques (Global)</h3>
                <div id="graph-bars">
                    </div>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURAÇÃO DO CONTADOR ---
        // Este é o seu "workspace" (espaço de trabalho) na API.
        const API_WORKSPACE = 'marcelo-links-musicais-v1';

        // *** A MÁGICA ESTÁ AQUI ***
        // Inicializa a biblioteca de contador que carregamos no <head>
        const counter = new Counter({ workspace: API_WORKSPACE });
        // ------------------------------------

        // Pega os elementos do HTML
        const artistInput = document.getElementById('artist-input');
        const songInput = document.getElementById('song-input');
        const searchButton = document.getElementById('search-button');
        const loadingMessage = document.getElementById('loading');
        
        const resultsContainer = document.getElementById('results-container');
        const artwork = document.getElementById('artwork');
        const songTitle = document.getElementById('song-title');
        const songArtist = document.getElementById('song-artist');
        const linksContainer = document.getElementById('links-container');
        const graphBarsContainer = document.getElementById('graph-bars');

        let currentSongKey = ''; // Chave única para a música
        let currentCounts = {}; // Objeto para guardar os cliques atuais

        searchButton.addEventListener('click', searchMusic);

        window.addEventListener('load', () => {
            const params = new URLSearchParams(window.location.search);
            const artistaDaUrl = params.get('artista');
            const musicaDaUrl = params.get('musica');

            if (artistaDaUrl && musicaDaUrl) {
                artistInput.value = artistaDaUrl;
                songInput.value = musicaDaUrl;
                searchButton.click();
            }
        });

        // --- FUNÇÕES DE CONTADOR (Usando a Biblioteca Correta) ---

        // Pega o clique ATUAL da API
        async function getCount(platformName) {
            try {
                // A chave é a música + plataforma
                const key = `${currentSongKey}-${platformName.toLowerCase()}`;
                
                // Usa a biblioteca "counter.get()"
                const result = await counter.get(key);
                return result.value || 0;

            } catch (error) {
                // É esperado um erro se a chave não existir.
                console.warn(`Chave nova para ${platformName}, iniciando contagem do 0.`);
                return 0;
            }
        }

        // Registra um NOVO clique na API
        async function trackClick(platformName) {
            try {
                // A chave é a música + plataforma
                const key = `${currentSongKey}-${platformName.toLowerCase()}`;
                
                // Usa a biblioteca "counter.up()" (subir)
                const result = await counter.up(key);
                
                // Atualiza nosso objeto de contagem local
                currentCounts[platformName] = result.value;

                // Atualiza a tela (Gráficos e Contadores)
                updateDisplay();

            } catch (error) {
                console.error('Erro ao registrar clique:', error);
            }
        }

        // Atualiza os números nos botões e redesenha os gráficos
        function updateDisplay() {
            const buttons = document.querySelectorAll('.music-platform-button');
            let maxClicks = 0;
            let platforms = [];

            buttons.forEach(button => {
                const platformName = button.dataset.platform;
                const clickCount = currentCounts[platformName] || 0;
                
                const counterSpan = button.querySelector('.click-counter');
                if (counterSpan) {
                    counterSpan.innerText = `${clickCount} cliques`;
                }
                platforms.push({ 
                    name: platformName, 
                    clicks: clickCount, 
                    class: button.dataset.class 
                });
                if (clickCount > maxClicks) {
                    maxClicks = clickCount;
                }
            });

            graphBarsContainer.innerHTML = '';
            
            if (maxClicks === 0) {
                 graphBarsContainer.innerHTML = '<p style="font-size:0.9em; color:#b3b3b3; text-align:left;">Nenhum clique registrado.</p>';
                 return;
            }

            platforms.forEach(platform => {
                const barWidth = maxClicks > 0 ? (platform.clicks / maxClicks) * 100 : 0;
                const barHTML = `
                    <div class="graph-bar-container">
                        <div class="graph-label">${platform.name}</div>
                        <div class="graph-bar-bg">
                            <div class="graph-bar ${platform.class}" style="width: ${barWidth}%;">
                                ${platform.clicks > 0 ? platform.clicks : ''}
                            </div>
                        </div>
                    </div>
                `;
                graphBarsContainer.innerHTML += barHTML;
            });
        }
        
        // --- FUNÇÕES PRINCIPAIS (Sem mudança aqui) ---

        async function searchMusic() {
            const artist = artistInput.value;
            const song = songInput.value;
            
            if (!artist || !song) {
                alert('Por favor, preencha o artista e a música.');
                return;
            }

            loadingMessage.style.display = 'block';
            resultsContainer.style.display = 'none';
            linksContainer.innerHTML = ''; 
            graphBarsContainer.innerHTML = '';
            
            const query = `${artist} ${song}`;
            currentSongKey = query.toLowerCase().replace(/[^a-z0-9]/g, '_'); 
            currentCounts = {}; 

            const platformsToCreate = [
                { name: 'Spotify', url: `https://open.spotify.com/search/${encodeURIComponent(query)}`, class: 'spotify' },
                { name: 'YouTube Music', url: `https://music.youtube.com/search?q=${encodeURIComponent(query)}`, class: 'youtubeMusic' },
                { name: 'Tidal', url: `https://listen.tidal.com/search?q=${encodeURIComponent(query)}`, class: 'tidal' }
            ];

            try {
                // 1. BUSCAR NO APPLE MUSIC
                const itunesResponse = await fetch(`https://itunes.apple.com/search?term=${encodeURIComponent(query)}&entity=song&limit=1`);
                const itunesData = await itunesResponse.json();

                if (itunesData.results && itunesData.results.length > 0) {
                    const track = itunesData.results[0];
                    artwork.src = track.artworkUrl100.replace('100x100', '300x300');
                    artwork.style.display = 'block';
                    songTitle.innerText = track.trackName;
                    songArtist.innerText = track.artistName;
                    platformsToCreate.unshift({ name: 'Apple Music', url: track.trackViewUrl, class: 'appleMusic' });
                } else {
                    songTitle.innerText = song;
                    songArtist.innerText = artist;
                    artwork.style.display = 'none';
                }

                // 2. BUSCAR NO DEEZER
                const deezerData = await searchDeezer(query);
                if (deezerData) {
                    platformsToCreate.unshift({ name: 'Deezer', url: deezerData.link, class: 'deezer' });
                }

                // 3. BUSCAR TODAS AS CONTAGENS DA API (em paralelo)
                loadingMessage.innerText = 'Buscando contadores...';
                
                const countPromises = platformsToCreate.map(platform => getCount(platform.name));
                const counts = await Promise.all(countPromises);
                
                // 4. CRIAR OS BOTÕES
                platformsToCreate.forEach((platform, index) => {
                    const count = counts[index];
                    currentCounts[platform.name] = count; 
                    createLinkButton(platform.name, platform.url, platform.class, count);
                });

                // 5. EXIBIR TUDO
                resultsContainer.style.display = 'block';
                updateDisplay(); 

            } catch (error) {
                console.error(error);
                alert('Ocorreu um erro ao buscar. Tente novamente.');
            } finally {
                loadingMessage.style.display = 'none';
                loadingMessage.innerText = 'Buscando...';
            }
        }

        // Função que cria os botões na tela
        function createLinkButton(platformName, url, platformClass, initialCount) {
            const button = document.createElement('a');
            button.href = url;
            button.target = '_blank';
            button.className = 'music-platform-button ' + platformClass;
            button.dataset.platform = platformName; 
            button.dataset.class = platformClass;

            button.innerHTML = `
                <span class="platform-name">${platformName}</span>
                <span class="click-counter">${initialCount} cliques</span>
            `;
            
            button.addEventListener('click', (e) => {
                trackClick(platformName);
            });

            linksContainer.appendChild(button);
        }

        // Função especial para buscar no Deezer
        function searchDeezer(query) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                const callbackName = 'deezerCallback'; 
                window[callbackName] = function(data) {
                    document.body.removeChild(script);
                    delete window[callbackName];
                    if (data.data && data.data.length > 0) {
                        resolve(data.data[0]); 
                    } else {
                        resolve(null); 
                    }
                };
                script.src = `https://api.deezer.com/search?q=${encodeURIComponent(query)}&output=jsonp&callback=${callbackName}`;
                script.onerror = () => {
                    delete window[callbackName];
                    reject(new Error('Falha ao carregar API do Deezer'));
                };
                document.body.appendChild(script);
            });
        }
    </script>
</body>
</html>
